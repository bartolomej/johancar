<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JohanCar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 900px;
            width: 100%;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
            aspect-ratio: 16/9;
        }
        #videoStream {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .joystick-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        #joystickCanvas {
            border-radius: 50%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            cursor: pointer;
            touch-action: none;
        }
        .status {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 0.9em;
        }
        .error {
            color: #f5576c;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-container">
            <img id="videoStream" src="/video" alt="Video Feed">
        </div>
        <div class="joystick-container">
            <canvas id="joystickCanvas" width="200" height="200"></canvas>
        </div>
        <div class="status" id="status">Ready</div>
        <div class="error" id="error"></div>
    </div>
    <script>
        const videoStream = document.getElementById('videoStream');
        const statusEl = document.getElementById('status');
        const errorEl = document.getElementById('error');

        videoStream.onerror = function() {
            errorEl.textContent = 'Video feed unavailable. Make sure the hardware is connected and sending video.';
            errorEl.style.display = 'block';
        };

        const canvas = document.getElementById('joystickCanvas');
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const maxRadius = 80;
        let isActive = false;
        let currentX = centerX;
        let currentY = centerY;
        let sendInterval = null;

        function drawJoystick() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#e0e0e0';
            ctx.beginPath();
            ctx.arc(centerX, centerY, maxRadius, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            const distance = Math.sqrt(Math.pow(currentX - centerX, 2) + Math.pow(currentY - centerY, 2));
            const limitedDistance = Math.min(distance, maxRadius);
            const angle = Math.atan2(currentY - centerY, currentX - centerX);
            
            const stickX = centerX + limitedDistance * Math.cos(angle);
            const stickY = centerY + limitedDistance * Math.sin(angle);
            
            ctx.fillStyle = isActive ? '#667eea' : '#764ba2';
            ctx.beginPath();
            ctx.arc(stickX, stickY, 30, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        function getJoystickData() {
            const dx = currentX - centerX;
            const dy = currentY - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const normalizedDistance = Math.min(distance / maxRadius, 1.0);
            const angle = Math.atan2(dy, dx);
            
            return {
                angle: angle,
                intensity: normalizedDistance,
                x: dx / maxRadius,
                y: dy / maxRadius
            };
        }

        function sendCommand() {
            if (!isActive) return;
            
            const data = getJoystickData();
            
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    angle: data.angle,
                    intensity: data.intensity,
                    x: data.x,
                    y: data.y
                })
            })
            .then(response => response.json())
            .then(data => {
                statusEl.textContent = 'Active';
            })
            .catch(error => {
                statusEl.textContent = 'Error sending command';
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
            });
        }

        function startSending() {
            if (sendInterval) return;
            isActive = true;
            sendCommand();
            sendInterval = setInterval(sendCommand, 50);
        }

        function stopSending() {
            if (sendInterval) {
                clearInterval(sendInterval);
                sendInterval = null;
            }
            isActive = false;
            currentX = centerX;
            currentY = centerY;
            drawJoystick();
            
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    angle: 0,
                    intensity: 0,
                    x: 0,
                    y: 0
                })
            });
            
            statusEl.textContent = 'Ready';
        }

        function updatePosition(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            currentX = clientX - rect.left;
            currentY = clientY - rect.top;
            drawJoystick();
        }

        canvas.addEventListener('mousedown', function(e) {
            updatePosition(e.clientX, e.clientY);
            startSending();
        });

        canvas.addEventListener('mousemove', function(e) {
            if (isActive) {
                updatePosition(e.clientX, e.clientY);
            }
        });

        canvas.addEventListener('mouseup', stopSending);
        canvas.addEventListener('mouseleave', stopSending);

        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            updatePosition(touch.clientX, touch.clientY);
            startSending();
        });

        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            if (isActive && e.touches.length > 0) {
                const touch = e.touches[0];
                updatePosition(touch.clientX, touch.clientY);
            }
        });

        canvas.addEventListener('touchend', stopSending);
        canvas.addEventListener('touchcancel', stopSending);

        drawJoystick();
    </script>
</body>
</html>

